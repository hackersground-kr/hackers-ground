name: On Hackathon Team App 1 Verified

on:
  issue_comment:
    types:
    - created
  workflow_dispatch:
    inputs:
      issue-number:
        description: 'Issue number'
        required: true
        default: ''
      inspected:
        description: 'Value indicating whether the verification process done by human or not'
        required: true
        default: 'false'
      verified:
        description: 'Value indicating whether the verification process is successful or not'
        required: true
        default: 'false'
      onlyissueclose:
        description: 'Value indicating whether the issue should be closed or not'
        required: true
        default: 'true'

permissions:
  contents: read
  id-token: write
  issues: write
  pull-requests: write

jobs:
  verification-start:
    name: 'Completing verification'

    runs-on: ubuntu-latest

    steps:
    - name: Check event payload
      shell: pwsh
      run: |
        $eventPayload = '${{ toJson(github) }}'

    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Get GitHub access token
      id: github-connect
      shell: pwsh
      run: |
        $token = ./gha-scripts/Get-GitHubAccessToken.ps1 `
          -AccessTokenIDs "${{ vars.ACCESS_TOKEN_IDS }}" `
          -ApimBaseUrl "${{ vars.APIM_BASE_URL }}" `
          -ApimApiKey "${{ secrets.APIM_SUBSCRIPTION_KEY }}"

        echo "::add-mask::$token"
        echo "token=$token" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8

    - name: Check issue details
      id: issue
      shell: pwsh
      env:
        GH_TOKEN: ${{ steps.github-connect.outputs.token }}
      run: |
        $payload = '${{ toJson(github) }}'
        $Issuenumber = "${{ github.event.inputs.issue-number }}"

        $result = $(./gha-scripts/Check-IssueDetailsForRoundVerification.ps1 `
          -IssueNumber "${{ github.event.inputs.issue-number }}" `
          -GitHubPayload $($payload | ConvertFrom-Json)) | ConvertFrom-Json

        if ("${{ github.event_name}}" -eq "workflow_dispatch") {
          $verified = ("${{ github.event.inputs.verified }}".ToLowerInvariant() -eq "true") ? "true" : "false"
          $invalid = ""
        } else {
          $verified = ("${{ github.event.comment.body }}".StartsWith("/ok")) ? "true" : "false"
          $invalid = ("${{ github.event.comment.body }}".StartsWith("/invalid")) ? "true" : ""
          $invalid = ("${{ github.event.comment.user.login }}" -eq "${{ github.event.issue.assignee.login }}") ? "" : "true"
        }

        echo "issueNumber=$($result.issueNumber)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        echo "issueType=$($result.issueType)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        echo "githubID=$($result.githubID)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        echo "assignee=$($result.assignee)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        echo "title=$($result.title)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        echo "teamName=$($result.teamName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        echo "teamRepository=$($result.teamRepository)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        echo "verified=$verified" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        echo "invalid=$invalid" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        
    - name: Add a label - NOT Verified
      if: |
         steps.issue.outputs.issueType == 'APP1' &&
         (steps.issue.outputs.verified == 'false' || steps.issue.outputs.invalid == 'true' || github.event.comment.user.login != github.event.issue.assignee.login)
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh issue edit ${{ steps.issue.outputs.issueNumber }} \
          --add-label "invalid" \
          -R ${{ github.event.repository.full_name }}

    - name: Comment to issue - NOT Verified
      if: |
        steps.issue.outputs.issueType == 'APP1' &&
        (steps.issue.outputs.verified == 'false' || steps.issue.outputs.invalid == 'true' || github.event.comment.user.login != github.event.issue.assignee.login ) &&
        github.event.inputs.onlyissueclose != 'false'
      uses: actions-cool/issues-helper@v3
      with:
        actions: 'create-comment'
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ steps.issue.outputs.issueNumber }}
        emoji: 'confused,eyes'
        body: |
          ğŸ‘‹ğŸ¼ @${{ steps.issue.outputs.githubID }} ë‹˜!

          íŒ€ ì•± ì œì¶œì„ í™•ì¸í•˜ëŠ” ê³¼ì •ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ğŸ˜¢

          ê³§ë°”ë¡œ ì‚¬ë¬´êµ­ì„ ì°¾ì•„ê°€ì„œ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”. ğŸ™

    - name: Close issue - NOT Verified
      if: |
       steps.issue.outputs.issueType == 'APP1' &&
        (steps.issue.outputs.verified == 'false' || steps.issue.outputs.invalid == 'true' || github.event.comment.user.login != github.event.issue.assignee.login )
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh issue close ${{ steps.issue.outputs.issueNumber }} \
          -c "ì´ìŠˆë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ìŠˆë¥¼ ë‹«ìŠµë‹ˆë‹¤." \
          -R ${{ github.event.repository.full_name }}

    - name: Add a label - Verified
      if: |
        steps.issue.outputs.issueType == 'APP1' &&
        steps.issue.outputs.verified == 'true' &&
        github.event_name != 'workflow_dispatch'  &&
        github.event.comment.user.login == github.event.issue.assignee.login
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh issue edit ${{ steps.issue.outputs.issueNumber }} \
          --add-label "verified" \
          --remove-label "verifying,invalid" \
          -R ${{ github.event.repository.full_name }}

    - name: Comment to issue - Verified
      if: |
        steps.issue.outputs.issueType == 'APP1' &&
        steps.issue.outputs.verified == 'true' &&
        github.event_name != 'workflow_dispatch' &&
        github.event.comment.user.login == github.event.issue.assignee.login
      uses: actions-cool/issues-helper@v3
      with:
        actions: 'create-comment'
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ steps.issue.outputs.issueNumber }}
        emoji: 'hooray'
        body: |
          ğŸ‘‹ğŸ¼ @${{ steps.issue.outputs.githubID }} ë‹˜!

          íŒ€ ì•± ì œì¶œ í™•ì¸ì´ ëë‚¬ìŠµë‹ˆë‹¤. ì¶•í•˜ë“œë¦½ë‹ˆë‹¤! ğŸ‰

          ê³„ì†í•´ì„œ ì•±ì„ ê°œë°œí•´ ì£¼ì„¸ìš”! ğŸ’ª ëë‚  ë•Œ ê¹Œì§€ ëë‚œ ê²Œ ì•„ë‹™ë‹ˆë‹¤.
          
          ë¶€ì§€ëŸ°íˆ ì½”ë”©í•˜ê³ , íŒ€ì›ë“¤ê³¼ ì†Œí†µí•˜ë©°, ë” ì¢‹ì€ ê²°ê³¼ë¬¼ì„ ë§Œë“¤ì–´ë´…ì‹œë‹¤. ğŸš€ ê·¸ë¦¬ê³  í•„ìš”í•˜ë©´ ê¸°ìˆ  ë©˜í† ë‹˜ê³¼ ë¹„ê¸°ìˆ  ë©˜í† ë‹˜ë“¤ê»˜ ë„ì›€ì„ ìš”ì²­í•˜ì„¸ìš”. ğŸ™

    - name: Close issue - Verified
      if: |
        steps.issue.outputs.issueType == 'APP1' &&
        steps.issue.outputs.verified == 'true' &&
        github.event_name != 'workflow_dispatch'  &&
        github.event.comment.user.login == github.event.issue.assignee.login
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh issue close ${{ steps.issue.outputs.issueNumber }} \
          -c "íŒ€ ì•± ì œì¶œì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. ì´ìŠˆë¥¼ ë‹«ìŠµë‹ˆë‹¤." \
          -R ${{ github.event.repository.full_name }}

    - name: Call Power Automate workflow
      if: |
        steps.issue.outputs.issueType == 'APP1'
      id: request
      uses: fjogeleit/http-request-action@v1
      with:
        url: ${{ secrets.PAU_ON_ROUND_3_VERIFIED_URL }}
        method: 'POST'
        data: '{ "issueNumber": ${{ steps.issue.outputs.issueNumber }}, "githubId": "${{ steps.issue.outputs.githubID }}", "teamName": "${{ steps.issue.outputs.teamName }}", "repositoryName": "${{ steps.issue.outputs.teamRepository }}", "verified": "${{ steps.issue.outputs.verified }}", "invalid": "${{ steps.issue.outputs.invalid }}", "onlyissueclose": "${{ github.event.inputs.onlyissueclose }}" }'
